name: CI synthesizer

on:
  push:
    branches: [ main ]
    paths:
      - 'package/**'
      - 'board/**'
      - 'configs/**'
      - '.github/workflows/ci.yml'
      - 'external.mk'
      - 'external.desc'
      - 'Config.in'
      
  pull_request:
  workflow_dispatch:
    inputs:
      instrument_cluster_os_tag:
        description: 'synthesizer OS tag to use'
        required: false
        default: 'main'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Disk space (before)
        run: df -h

      - name: Free disk space
        uses: endersonmenezes/free-disk-space@v3
        with:
          remove_android: true
          remove_dotnet: true
          remove_haskell: true
          remove_swap: true
          remove_tool_cache: true

      - name: Disk space (after)
        run: df -h
      
      - name: Install dependencies
        run: |
          sudo apt clean
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git python3 unzip rsync bc libncurses5-dev \
            bison flex cpio unzip rsync wget libsdl2-dev libsdl2-image-dev \
            libsdl2-mixer-dev libsdl2-ttf-dev libfreetype6-dev libjpeg-dev \
            libpng-dev pkg-config

      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Checkout Buildroot 2025.05
        uses: actions/checkout@v4
        with:
          repository: "buildroot/buildroot"
          ref: "2025.05"
          path: buildroot

      - name: Build
        run: |
          make -C buildroot BR2_EXTERNAL=../ O=../output raspberrypi4_64_defconfig
          make -C buildroot O=../output

      - name: Rename image for release
        run: |
          mv output/images/sdcard.img output/images/synthesizer-os-pi4_64.img

      - name: Upload image to "latest" release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          files: output/images/synthesizer-os-pi4_64.img
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.SYNTHESIZER_OS_RELEASE_PAT }}

      - name: Upload output image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: images-raspberrypi4_64
          path: output/images/
